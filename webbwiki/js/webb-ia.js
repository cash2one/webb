define(["wcl/webb"],function(t){var i=new t,e=(new Date).getTime(),s=0,n=null,o={},r=function(t){this.webb=i,this.group=0,this.start=null,this.stayTime=0,this.heartTime=[],this.heartTimer=null,this.scrollTimer=null,this.resizeTimer=null,this.flag=o,this.options={useBase:!1,useFocus:!1,useBlur:!1,useHeart:!1,useVsb:!1},this._init(t)};return $.extend(r.prototype,{send:function(t){t.t||(t.t=(new Date).getTime()),t.o=s,s+=1,t.g=this.group,this._setHistory(t),this.webb.sendPack("view",t)},sendNow:function(t){t.t||(t.t=(new Date).getTime()),t.o=s,s+=1,t.g=this.group,this._setHistory(t),this.webb.sendNow("view",t)},_init:function(t){this.start=e;for(var i in t)this.options[i]=t[i];this.group=this._getRandomNum()||0,this._initEvents()},_getRandomNum:function(){var t=89999*Math.random()+1e4;return t=parseInt(t,10)},_setHistory:function(t){if(t.type){var i=t.type,e=t.action?t.action:"";"w"==i&&e&&(i="w_"+e),n?n[i]?n[i]++:n[i]=1:(n={},n[i]=1)}},_sendFocusLog:function(){var t=this;t.send({type:"w",action:"focus",ext:{vsb:document.visibilityState?document.visibilityState:0}})},_sendBlurLog:function(){var t=this;t.send({type:"w",action:"blur",ext:{vsb:document.visibilityState?document.visibilityState:0}})},_sendVisibilitychangeLog:function(){var t=this;t.send({type:"w",action:"vsb",ext:{vsb:document.visibilityState?document.visibilityState:0}})},_initEvents:function(){var t=this,i=$(window);!t.options.useBase&&!t.options.useFocus||t.flag.focus||(i.bind("focus.webb_ia",function(){t._sendFocusLog()}),t.flag.focus=1),!t.options.useBase&&!t.options.useBlur||t.flag.blur||(i.bind("blur.webb_ia",function(){t._sendBlurLog()}),t.flag.blur=1),!t.options.useBase&&!t.options.useVsb||t.flag.vsb||($(document).bind("visibilitychange.webb_ia",function(){t._sendVisibilitychangeLog()}),t.flag.vsb=1),!t.options.useBase&&!t.options.useResize||t.flag.resize||(i.bind("resize.webb_ia",function(i){t.collectPoint("resize",i)}),t.flag.resize=1),!t.options.useBase&&!t.options.useHeart||t.flag.heart||(t.startHeart(),t.flag.heart=1),!t.options.useBase&&!t.options.useScroll||t.flag.scroll||(i.bind("scroll",function(i){t.collectPoint("scroll",i)}),t.flag.scroll=1)},destory:function(){$(window).unbind(".useraction"),null!==this.heartTimer&&clearTimeout(this.heartTimer),this.heartTimer=null},fb:function(){var t,i=this.heartTime.length;return t=0===i||1===i?3e3:this.heartTime[i-1]+this.heartTime[i-2],this.heartTime.push(t),t},sendHeart:function(t){var i=(new Date).getTime(),e=0===t?this.stayTime:i-this.start,s={type:"heart",stay_time:e,t:i};n&&(s.hist=n),this.sendNow(s)},startHeart:function(){var t=this,i=t.fb();t.stayTime+=i,t.heartTimer=setTimeout(function(){t.sendHeart(0),t.startHeart()},i)},collectPoint:function(t){function i(){n[s]=setTimeout(function(){n.send(e(t)),n[s]=null},1e3)}function e(t){if("scroll"===t){var i=$(window),e=i.scrollTop(),s=i.scrollLeft();return{type:"w",action:"scroll",ext:{y:e,x:s}}}return"resize"===t?{type:"w",action:"resize",ext:{w:$(window).width(),h:$(window).height()}}:void 0}var s=t+"Timer",n=this;null===n[s]&&i()}}),r});